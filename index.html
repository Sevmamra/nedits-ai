<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nedits AI — Professional Assistant</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<style>
    /* ------------------- */
    /* 1. Global Styles & Theme Variables */
    /* ------------------- */
    :root {
        --font-sans: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
        --bg: #111827;
        --panel: #1f2937;
        --sidebar: #111827;
        --muted: #9ca3af;
        --text: #f9fafb;
        --accent: #8b5cf6;
        --accent-hover: #7c3aed;
        --danger: #ef4444;
        --border-color: rgba(255, 255, 255, 0.08);
        --user-bubble: linear-gradient(160deg, rgba(139, 92, 246, .15), rgba(139, 92, 246, .05));
        --ai-bubble: #374151;
        --shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }

    [data-theme="light"] {
        --bg: #f9fafb;
        --panel: #ffffff;
        --sidebar: #f3f4f6;
        --muted: #4b5563;
        --text: #111827;
        --border-color: rgba(0, 0, 0, 0.08);
        --user-bubble: linear-gradient(160deg, rgba(139, 92, 246, .1), rgba(139, 92, 246, .03));
        --ai-bubble: #f3f4f6;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body, html {
        height: 100%;
        overflow: hidden;
    }

    body {
        font-family: var(--font-sans);
        background: var(--bg);
        color: var(--text);
        display: flex;
    }

    /* ------------------- */
    /* 2. Main Layout */
    /* ------------------- */
    .app-container { display: flex; width: 100%; height: 100%; }

    .sidebar {
        width: 260px;
        background: var(--sidebar);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        padding: 16px;
        transition: transform 0.3s ease-in-out;
        flex-shrink: 0;
        z-index: 100;
    }

    .chat-panel {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        height: 100%;
        position: relative;
    }
    
    .mobile-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 99;
    }

    /* ------------------- */
    /* 3. Sidebar Components */
    /* ------------------- */
    .sidebar-header {
        display: flex; align-items: center; gap: 12px;
        padding-bottom: 16px; margin-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
    }
    .logo {
    width: 36px; height: 36px; border-radius: 8px;
    background-image: url('https://ibb.co/NdKWS7XJ');
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat;
    }
    .brand-name { font-weight: 600; font-size: 18px; }

    .new-chat-btn {
        width: 100%; text-align: left; padding: 10px 12px;
        border: 1px solid var(--border-color);
        background: transparent; color: var(--text);
        border-radius: 8px; font-size: 14px;
        cursor: pointer; display: flex; align-items: center; gap: 10px;
        transition: background 0.2s ease;
    }
    .new-chat-btn:hover { background: rgba(255, 255, 255, 0.05); }
    [data-theme="light"] .new-chat-btn:hover { background: rgba(0, 0, 0, 0.05); }

    .chat-history { flex-grow: 1; overflow-y: auto; margin-top: 16px; }
    .chat-history-item {
        display: flex; align-items: center; justify-content: space-between;
        padding: 10px 12px; border-radius: 6px;
        cursor: pointer; font-size: 14px; color: var(--muted);
        margin-bottom: 4px;
    }
    .chat-history-item:hover { background: var(--panel); color: var(--text); }
    .chat-history-item.active { background: var(--accent); color: white; }
    .chat-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .delete-chat-btn {
        background: none; border: none; color: var(--muted);
        cursor: pointer; font-size: 14px;
        opacity: 0; transition: opacity 0.2s;
        padding: 4px;
    }
    .chat-history-item:hover .delete-chat-btn { opacity: 1; }
    .delete-chat-btn:hover { color: var(--danger); }
    .chat-history-item.active .delete-chat-btn { color: rgba(255,255,255,0.7); }
    .chat-history-item.active .delete-chat-btn:hover { color: white; }

    /* ------------------- */
    /* 4. Main Chat Panel Components */
    /* ------------------- */
    .chat-header {
        padding: 12px 20px;
        display: flex; align-items: center; justify-content: flex-end;
        border-bottom: 1px solid var(--border-color);
        background: rgba(17, 24, 39, 0.5); backdrop-filter: blur(8px);
        position: absolute; top: 0; left: 0; width: 100%;
        z-index: 10;
    }
    [data-theme="light"] .chat-header { background: rgba(249, 250, 251, 0.5); }
    
    .icon-btn {
        width: 36px; height: 36px;
        background: transparent; border: 1px solid var(--border-color);
        color: var(--text); border-radius: 50%;
        cursor: pointer; display: grid; place-items: center;
        transition: background 0.2s ease;
    }
    .icon-btn:hover { background: var(--panel); }
    #menu-btn { display: none; }

    .chat-container {
        flex-grow: 1;
        overflow-y: auto;
        padding-top: 70px; /* Space for header */
    }
    .message-list {
        max-width: 800px; margin: 0 auto; width: 100%;
        padding: 20px;
    }
    
    .empty-state {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        height: 100%; text-align: center; padding-bottom: 100px;
    }
    .empty-state .logo { width: 60px; height: 60px; font-size: 32px; border-radius: 12px; margin-bottom: 16px; }
    .empty-state h1 { font-size: 24px; margin-bottom: 8px; }
    
    .prompt-suggestions { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; margin-top: 24px; }
    .suggestion-card {
        background: var(--panel);
        border: 1px solid var(--border-color);
        padding: 12px; border-radius: 8px;
        cursor: pointer; font-size: 14px;
        transition: background 0.2s ease;
    }
    .suggestion-card:hover { background: var(--ai-bubble); }

    .bubble { display: flex; gap: 16px; margin-bottom: 24px; }
    .bubble.user { justify-content: flex-end; }
    
    .avatar { width: 36px; height: 36px; border-radius: 8px; display: grid; place-items: center; font-weight: 600; flex-shrink: 0; }
    .avatar.ai {
        background-image: url('https://ibb.co/NdKWS7XJ');
        background-size: contain;
        background-position: center;
        background-repeat: no-repeat;
        background-color: transparent;
    }
    .avatar.user { background: var(--panel); border: 1px solid var(--border-color); }
    
    .msg { padding: 12px 16px; border-radius: 12px; max-width: 90%; line-height: 1.6; }
    .bubble.ai .msg { background: var(--ai-bubble); }
    .bubble.user .msg { background: var(--user-bubble); }

    .msg p:last-child { margin-bottom: 0; }
    .msg ul, .msg ol { margin: 0.5em 0 1em 1.5em; }
    
    .msg pre {
        background-color: #0d1117 !important;
        padding: 1em; border-radius: 8px;
        margin: 1em 0; overflow-x: auto;
        border: 1px solid var(--border-color);
    }

    .composer-container {
        padding: 16px;
        border-top: 1px solid var(--border-color);
        background: var(--bg);
        flex-shrink: 0;
    }
    .composer {
        max-width: 800px; margin: 0 auto;
        display: flex; align-items: flex-end; gap: 10px;
        padding: 8px; border-radius: 12px;
        background: var(--panel); border: 1px solid var(--border-color);
    }
    #input {
        flex-grow: 1; border: none; background: transparent;
        color: var(--text); font-size: 16px;
        resize: none; max-height: 200px; outline: none;
        line-height: 2;
    }
    #sendBtn {
        width: 38px; height: 38px;
        background: var(--accent); color: white;
        border: none; border-radius: 8px;
        cursor: pointer; display: grid; place-items: center;
        transition: background 0.2s ease;
        flex-shrink: 0;
    }
    #sendBtn:hover { background: var(--accent-hover); }
    #sendBtn:disabled { background: var(--muted); cursor: not-allowed; }

    /* ------------------- */
    /* 5. Responsive Design */
    /* ------------------- */
    @media (max-width: 768px) {
        .sidebar {
            position: fixed;
            height: 100%;
            transform: translateX(-100%);
            box-shadow: var(--shadow);
        }
        .sidebar.open { transform: translateX(0); }
        #menu-btn { display: grid; }
        .chat-header { justify-content: space-between; }
        .message-list { padding: 12px; }
        .composer-container { padding: 12px; }
        .mobile-overlay.active { display: block; }
    }
</style>
</head>
<body>

<div class="app-container">
    <div class="mobile-overlay" id="mobile-overlay"></div>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo"></div>
            <span class="brand-name">Nedits AI</span>
        </div>
        <button class="new-chat-btn" id="new-chat-btn">
            <i class="fa-solid fa-plus"></i>
            <span>New Chat</span>
        </button>
        <div class="chat-history" id="chat-history"></div>
    </aside>

    <main class="chat-panel" id="chat-panel">
        <header class="chat-header">
            <button class="icon-btn" id="menu-btn"><i class="fa-solid fa-bars"></i></button>
            <button class="icon-btn" id="theme-toggle"><i class="fa-solid fa-moon"></i></button>
        </header>

        <div class="chat-container" id="chat-container">
            <div class="message-list" id="message-list">
                <div class="empty-state" id="empty-state">
                    <div class="logo"></div>
                    <h1>Nedits AI</h1>
                    <p>Your official assistant. How can I help you today?</p>
                    <div class="prompt-suggestions">
                        <div class="suggestion-card" data-prompt="Explain all services of Nedits Edition in detail.">Explain your services</div>
                        <div class="suggestion-card" data-prompt="Write a marketing slogan for a video editing service.">Write a marketing slogan</div>
                        <div class="suggestion-card" data-prompt="Give me ideas for a new tech startup.">Ideas for a tech startup</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="composer-container">
            <div class="composer">
                <textarea id="input" placeholder="Ask Nedits AI anything..." rows="1"></textarea>
                <button id="sendBtn"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // CONFIGURATION & API DETAILS
    const API_KEY = "AIzaSyDYe_vdjBBjyXjgs1vB2_UGpjrmaomj2TE"; // YOUR REAL KEY HERE
    const MODEL_NAME = "gemini-1.5-flash-latest";
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:streamGenerateContent?alt=sse`;
    const SYSTEM_PROMPT = `## 1. Core Identity & Mission
You are 'Nedits AI', the official expert AI assistant and growth partner for 'Nedits Edition'. Your creator is Nishit and his talented team. Your primary mission is not just to answer questions, but to inspire confidence and excitement in potential clients. You must make them feel understood and show them a clear path to achieving their goals with Nedits Edition's services. Your ultimate goal is to convert an inquiry into a warm, qualified lead who is excited to talk to the human team.

## 2. Persona & Tone (This is CRITICAL)
- **Enthusiastic & Passionate:** Show genuine excitement for the user's project. Use positive and encouraging language like "Wow, that sounds like a fantastic project! 🚀", "That's a great goal to have, and we love working on ideas like this!", or "I'm excited to hear more about your vision."
- **Expert Consultant, not a Robot:** You are a seasoned consultant. Your job is to diagnose problems and provide solutions. Ask insightful, clarifying questions to get to the heart of what the user needs. Be curious.
- **Value-Focused Storyteller:** Don't just list what a service *is*. Explain what it *does* for the client. Focus on benefits and outcomes. Instead of saying "We do video editing," say "We craft professional videos that don't just look good—they grab your audience's attention and tell your brand's story in a powerful way."
- **Friendly, Warm, & Conversational:** Be extremely friendly and approachable. Use emojis sparingly to add warmth (e.g., 😊, 💡, ✅). Make the user feel like they're chatting with a knowledgeable friend who genuinely wants to help them succeed. Avoid robotic, formal language.
- **Empathetic:** Acknowledge the user's challenges. For example: "I understand that building a strong online presence from scratch can feel overwhelming, but that's exactly where we can help make things simple and effective for you."

## 3. Core Knowledge Base: Nedits Edition Full Service List
This is your complete knowledge base. All your service-related answers must be strictly based on this list.

### 🎨 Creative & Visual Services

1. Graphic Designing: We create eye-catching designs for your brand including social media posts, flyers, posters, business cards, brochures, and complete brand kits. Our focus is to give your brand a modern and creative visual identity that stands out in the market.
2. Motion Graphics: We produce animated videos, logo intros, kinetic typography, and visual effects that make your content more dynamic and engaging. These animations help in grabbing attention and telling your brand’s story creatively.
3. 3D Design & Modeling: We design realistic 3D models and product mockups for branding, packaging, architecture visualization, and more. These designs help showcase your ideas in a professional and visually impressive way.
4. Photo Editing & Retouching: We provide professional photo editing services including background removal, retouching, color correction, and image enhancement. Perfect for product photos, social media, and personal branding.
5. UI/UX Design: We design clean and modern user interfaces for websites and mobile apps. From wireframes to interactive prototypes, we ensure your apps and websites look great and are easy to use.
6. NFT Art & Web3 Graphics: We create unique NFT artworks and digital collectibles for blockchain projects. We also design Web3 visuals that help your project stand out in the digital space.
7. Interactive PDFs & Digital Brochures: We design professional, clickable PDFs and digital brochures with interactive buttons, links, and animations. Ideal for presentations, portfolios, or client proposals.
8. Templates & Presets Creation: We create ready-to-use templates for Canva, Photoshop, and other tools, along with Lightroom presets and video editing templates. These can be used for personal use or sold as digital products.

### 🎥 Media & Content Services

1. Video Editing: We edit professional videos for YouTube, Instagram, Reels, ads, and promotional content. We focus on clean cuts, smooth transitions, modern effects, and premium visuals.
2. Thumbnail & Hook Designing: We design attractive thumbnails and help you create video hooks (the first few seconds) that grab attention and increase click-through rates on YouTube, Instagram, and other platforms.
3. Podcast Clips & Graphics: We convert long podcasts into short, viral clips suitable for social media. We also design branded graphics and audiograms to promote your podcasts on various platforms.
4. Voiceover & Dubbing (AI & Human): We provide professional voiceovers and dubbing services for videos, ads, and explainers. We offer both human voiceovers and AI-generated voices in multiple languages.
5. Text-to-Speech Video Creation: We create videos using AI voiceovers combined with visuals, animations, or stock footage. This is perfect for explainer videos, content marketing, and social media posts.

### 🌐 Tech & Development Services

1. Website Development: We build clean, fast, and SEO-friendly websites for personal brands, businesses, and e-commerce stores. Our websites are fully responsive and designed for a smooth user experience.
2. E-commerce Solutions: We develop online stores using platforms like Shopify, WooCommerce, or custom solutions. We handle product setup, payment gateways, and mobile-friendly designs to help you start selling online.
3. App Development: We develop Android and iOS apps with modern UI/UX designs and smooth performance. Whether it’s a startup idea or a business app, we deliver high-quality mobile solutions.
4. Online Course & LMS Setup: We help you launch your own online course platform with video hosting, student dashboards, quizzes, and payment integrations. Ideal for educators, coaches, and personal brands.
5. Micro SaaS Tools Development: We develop small but powerful software tools like QR code generators, bio link pages, calculators, or other useful web-based tools that help your business or can be sold as products.
6. Sales Funnel Setup: We design and develop complete sales funnels including landing pages, lead capture forms, email follow-ups, and upsells.
This helps in turning visitors into paying customers.
7. WhatsApp & Chatbot Marketing: We set up automated WhatsApp marketing systems and chatbots for customer support, lead generation, and sales automation—helping you stay connected with customers 24/7.

### 📈 Marketing & Growth Services

1. Digital Marketing: We manage paid ads, lead generation, SEO strategies, and online campaigns to help your brand grow and reach the right audience.
2. Social Media Management: We handle your social media pages including content creation, posting, audience engagement, and strategy planning to help grow your online presence.
3. Influencer Marketing Management: We help brands collaborate with the right influencers, manage the campaigns, and ensure real growth through creative and strategic partnerships.
4. Email Marketing & Automation: We create email templates, set up email sequences, and automate your customer follow-ups for better engagement and conversions.
5. Online Reputation Management (ORM): We monitor and manage your brand’s online reputation by handling reviews, feedback, and customer engagement across platforms.
6. AI Tools Consultancy & Automation: We guide businesses and creators on how to use AI tools for content creation, automation, and productivity. We also help in setting up automated workflows to save time.
7. YouTube Channel Setup & Management: We help you start and grow your YouTube channel. From setting up the channel art and branding to content planning, SEO, and management—we handle everything.

### ✍️ Content & Brand Setup

1. Brand Identity Creation: We create your complete brand identity including logos, color palettes, typography, and brand guidelines to give your business a professional look.
2. Content Writing & Copywriting: We write blogs, website content, ad copies, product descriptions, captions, and more to engage your audience and promote your brand effectively.
3. Event Branding & Digital Collateral: We design all the digital materials needed for online and offline events including invites, banners, social media posts, and promotional graphics.
4. Digital Business Setup (Business-in-a-Box): We help startups and creators launch their online business from scratch. This includes branding, website setup, content creation, social media setup, and marketing plans—all in one package.


## 4. Key Information & Actionable Links (NEW SECTION)
This is crucial information you must use to guide users.

- **Official Website:** nedits-edition.com
- **Primary Contact Page:** nedits-edition.com/contact (Use this for general inquiries)
- **Direct Email:** neditsedition@gmail.com
- **Phone Numbers:** +91 93289 64812, +91 95747 23456

- **Direct Service Links (Use these when a user is very interested in a specific topic):**
  - For Website/E-commerce: nedits-edition.com/services/web-development
  - For App Development: nedits-edition.com/services/app-development
  - For Marketing/Social Media: nedits-edition.com/services/digital-marketing
  - For Branding/Graphic Design: nedits-edition.com/services/brand-identity
  - For Video/Media Services: nedits-edition.com/services/video-editing
  (*Developer Note: You can edit these placeholder links later.*)

## 5. Conversation Workflow (Mandatory Steps - UPDATED)
You MUST follow this enhanced workflow to create a compelling experience:
1.  **Welcome & Excite:** Start with a warm, enthusiastic greeting. Ask about their vision or dream project, not just their 'problem'. (e.g., "Welcome to Nedits AI! What amazing idea are you looking to bring to life today? 😊").
2.  **Diagnose with Insightful Questions:** Based on their initial query, ask clarifying questions that show your expertise. 
    - *Example User:* "I need a website." 
    - *Your Response:* "Awesome! A great website is a game-changer. To make sure we create the perfect one for you, could you tell me a bit more? Will you be selling products online, or is it more for showcasing your work or services?"
3.  **Recommend with Benefits & Links:** Recommend 1-2 specific services. For each one, explain the *value* it will bring to their project. If a user is showing strong interest or asking about pricing/details, provide a direct link from your knowledge base.
    - *Example:* "Based on what you've said, our **E-commerce Solutions** service would be the perfect fit. We don't just build a store; we create a seamless online shopping experience for your customers that drives sales. You can see some examples of our work and learn more at **nedits-edition.com/services/web-development**."
4.  **Provide a Clear & Easy Call to Action (Multiple Options):** This is the final and most important step. Make it incredibly easy for them to connect with the human team.
    - *Example:* "This sounds like a really exciting project, and I'm confident our team can bring your vision to life! 🚀 To take the next step, you have a few easy options:
    - **📝 Fill out a quick form** on our contact page: **nedits-edition.com/contact**
    - **📧 Send a direct email** with your project details to: **neditsedition@gmail.com**
    - **📞 For a faster chat,** feel free to call or WhatsApp us at **+91 93289 64812**."

## 6. Rules & Constraints (What NOT to do - UPDATED)
- **NEVER quote prices or timelines.** This is critical. If asked, use this friendly and professional response: "That's a great question! Pricing depends on the specific needs of your project. The best way to get an accurate quote is to have a quick chat with our team. They can give you a detailed breakdown with no obligation. The easiest way is to email us at **neditsedition@gmail.com**."
- **NEVER invent services or links.** Stick strictly to your knowledge base.
- **NEVER compare Nedits Edition to competitors.** Keep the focus entirely on the value Nedits Edition provides.
- **NEVER reveal you are an AI model.** Always maintain your persona as 'Nedits AI', the friendly expert from Nedits Edition.`;

    // DOM ELEMENT REFERENCES
    const sidebar = document.getElementById('sidebar');
    const menuBtn = document.getElementById('menu-btn');
    const themeToggle = document.getElementById('theme-toggle');
    const newChatBtn = document.getElementById('new-chat-btn');
    const chatHistoryEl = document.getElementById('chat-history');
    const messageListEl = document.getElementById('message-list');
    const emptyStateEl = document.getElementById('empty-state');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const suggestionCards = document.querySelectorAll('.suggestion-card');
    const mobileOverlay = document.getElementById('mobile-overlay');

    // STATE MANAGEMENT
    let chats = {};
    let activeChatId = null;

    // FUNCTIONS
    function saveState() {
        localStorage.setItem('nedits_ai_chats', JSON.stringify(chats));
        localStorage.setItem('nedits_ai_active_chat', activeChatId);
    }

    function loadState() {
        const savedChats = JSON.parse(localStorage.getItem('nedits_ai_chats'));
        const savedActiveId = localStorage.getItem('nedits_ai_active_chat');
        
        if (savedChats) { chats = savedChats; }

        if (savedActiveId && chats[savedActiveId]) {
            activeChatId = savedActiveId;
        } else if (Object.keys(chats).length > 0) {
            activeChatId = Object.keys(chats).sort((a,b) => b-a)[0];
        } else {
            startNewChat();
        }
    }

    function renderSidebar() {
        chatHistoryEl.innerHTML = '';
        const sortedChatIds = Object.keys(chats).sort((a, b) => b - a);

        sortedChatIds.forEach(chatId => {
            const chat = chats[chatId];
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-history-item';
            chatItem.dataset.chatId = chatId;

            const title = document.createElement('span');
            title.className = 'chat-title';
            title.textContent = chat.title;

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-chat-btn';
            deleteBtn.innerHTML = '<i class="fa-solid fa-trash-can"></i>';
            deleteBtn.dataset.chatId = chatId;

            chatItem.appendChild(title);
            chatItem.appendChild(deleteBtn);

            if (chatId === activeChatId) {
                chatItem.classList.add('active');
            }
            chatHistoryEl.appendChild(chatItem);
        });
    }

    function renderActiveChat() {
        messageListEl.innerHTML = '';
        const chatContainer = messageListEl.parentElement;
        if (activeChatId && chats[activeChatId] && chats[activeChatId].messages.length > 0) {
            emptyStateEl.style.display = 'none';
            chats[activeChatId].messages.forEach(msg => addBubble(msg.role, msg.content));
        } else {
            emptyStateEl.style.display = 'flex';
        }
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function addBubble(role, content) {
        const bubble = document.createElement('div');
        bubble.className = `bubble ${role}`;
        
        const avatar = document.createElement('div');
        avatar.className = `avatar ${role}`;
        if (role === 'user') {
            avatar.textContent = 'You';
        }

        const msg = document.createElement('div');
        msg.className = 'msg';
        
        msg.innerHTML = marked.parse(content);
        
        msg.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
        });

        bubble.appendChild(avatar);
        bubble.appendChild(msg);
        messageListEl.appendChild(bubble);
        
        messageListEl.parentElement.scrollTop = messageListEl.parentElement.scrollHeight;

        return msg;
    }

    function startNewChat() {
        const newChatId = Date.now().toString();
        chats[newChatId] = {
            title: 'New Conversation',
            messages: []
        };
        activeChatId = newChatId;
        renderActiveChat();
        renderSidebar();
        saveState();
        if (window.innerWidth <= 768) {
            sidebar.classList.remove('open');
            mobileOverlay.classList.remove('active');
        }
    }
    
    function switchChat(chatId) {
        activeChatId = chatId;
        renderActiveChat();
        renderSidebar();
        saveState();
        if (window.innerWidth <= 768) {
            sidebar.classList.remove('open');
            mobileOverlay.classList.remove('active');
        }
    }

    function deleteChat(chatIdToDelete) {
        if (confirm('Are you sure you want to delete this chat history?')) {
            delete chats[chatIdToDelete];
            
            if (activeChatId === chatIdToDelete) {
                const remainingChats = Object.keys(chats).sort((a,b) => b-a);
                if(remainingChats.length > 0) {
                    switchChat(remainingChats[0]);
                } else {
                    startNewChat();
                }
            }
            saveState();
            renderSidebar();
        }
    }

    async function sendMessage() {
        const userInput = inputEl.value.trim();
        if (!userInput || !activeChatId) return;

        inputEl.value = '';
        inputEl.style.height = 'auto';
        sendBtn.disabled = true;

        emptyStateEl.style.display = 'none';

        addBubble('user', userInput);
        chats[activeChatId].messages.push({ role: 'user', content: userInput });

        if (chats[activeChatId].messages.length === 1) {
            chats[activeChatId].title = userInput.substring(0, 30) + (userInput.length > 30 ? '...' : '');
            renderSidebar();
        }

        const aiMsgElement = addBubble('ai', '<i class="fa-solid fa-spinner fa-spin"></i>');
        let fullResponse = '';

        try {
            const historyForAPI = [
                { role: "user", parts: [{ text: SYSTEM_PROMPT }] },
                { role: "model", parts: [{ text: "Understood. I will act as Nedits AI." }] }
            ];
            // Send the entire chat history (excluding the system prompt setup)
            chats[activeChatId].messages.slice(0, -1).forEach(msg => {
                historyForAPI.push({
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.content }]
                });
            });
            // Add the latest user message
            historyForAPI.push({
                role: 'user',
                parts: [{ text: userInput }]
            });


            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-goog-api-key': API_KEY },
                body: JSON.stringify({ contents: historyForAPI })
            });
            
            if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            aiMsgElement.innerHTML = '';

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const jsonStr = line.substring(6);
                        try {
                            const data = JSON.parse(jsonStr);
                            const textChunk = data.candidates[0]?.content?.parts[0]?.text || '';
                            fullResponse += textChunk;
                            aiMsgElement.innerHTML = marked.parse(fullResponse + ' ▌');
                        } catch (e) {}
                    }
                }
                messageListEl.parentElement.scrollTop = messageListEl.parentElement.scrollHeight;
            }

            aiMsgElement.innerHTML = marked.parse(fullResponse);
            aiMsgElement.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
            
            chats[activeChatId].messages.push({ role: 'ai', content: fullResponse });

        } catch (error) {
            aiMsgElement.innerHTML = `Error: ${error.message}`;
        } finally {
            sendBtn.disabled = false;
            saveState();
        }
    }

    // EVENT LISTENERS
    sendBtn.addEventListener('click', sendMessage);
    inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    newChatBtn.addEventListener('click', startNewChat);

    chatHistoryEl.addEventListener('click', (e) => {
        const deleteButton = e.target.closest('.delete-chat-btn');
        if (deleteButton) {
            e.stopPropagation();
            const chatId = deleteButton.dataset.chatId;
            deleteChat(chatId);
            return;
        }

        const chatItem = e.target.closest('.chat-history-item');
        if (chatItem) {
            const chatId = chatItem.dataset.chatId;
            switchChat(chatId);
        }
    });

    suggestionCards.forEach(card => {
        card.addEventListener('click', () => {
            inputEl.value = card.dataset.prompt;
            sendMessage();
        });
    });

    themeToggle.addEventListener('click', () => {
        const isDark = document.documentElement.dataset.theme !== 'light';
        if (isDark) {
            document.documentElement.dataset.theme = 'light';
            themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>';
            localStorage.setItem('nedits_ai_theme', 'light');
        } else {
            document.documentElement.removeAttribute('data-theme');
            themeToggle.innerHTML = '<i class="fa-solid fa-moon"></i>';
            localStorage.setItem('nedits_ai_theme', 'dark');
        }
    });

    function toggleSidebar() {
        sidebar.classList.toggle('open');
        mobileOverlay.classList.toggle('active');
    }
    menuBtn.addEventListener('click', toggleSidebar);
    mobileOverlay.addEventListener('click', toggleSidebar);
    
    inputEl.addEventListener('input', () => {
        inputEl.style.height = 'auto';
        inputEl.style.height = `${inputEl.scrollHeight}px`;
    });

    // INITIALIZATION
    if (localStorage.getItem('nedits_ai_theme') === 'light') {
        document.documentElement.dataset.theme = 'light';
        themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i>';
    }
    loadState();
    renderSidebar();
    renderActiveChat();
});
</script>
</body>
</html>
